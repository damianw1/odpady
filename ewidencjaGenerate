<?php

/**
W tym pliku do utworzenia pdf-u użyłem gotowej biblioteki mpdf, która z kodu html tworzy pdf-a
*/
class EwidencjaGenerate {
	    
    private $db;
    
	function __construct() {
		$this->db = new DataBase();
    }
    
    function checkVariables($month, $year){
        $error = "";
        $data_sql = $year."-".$month;
        if(empty($month) || empty($year)){
            $error .= "Wszystkie pola muszą być wypełnione <br />";
        }
        if(!preg_match('/([0-9]+$)/', $year)){
            $error .= "Rok musi być liczbą <br />";
        }
        if(strlen($year) != 4){
            $error .= "Rok musi posiadać cztery cyfry <br />";
        }
        if($error == ""){
            $query = "SELECT DISTINCT id_odpad FROM karta where data LIKE CONCAT ('%$data_sql%')";
            $query = $this->db->query($query);
            if(mysql_num_rows($query)==0){
                $error .= "W bazie nie ma kart przekazania odpadu dla wybranego okresu czasowego";
            }
        }
        return $error;
    }
    
    function generate($month, $year){
        $month = $this->db->validate($month);
        $year = $this->db->validate($year);
        $check = $this->checkVariables($month, $year);
        if($check == ""){
            $this->check_folder($year, $month);
            $tabela = $this->TablePart1($year, $month);
            $result[0] = 1;
            //$result[1] = '<a href="ewidencja/'.$year."/".$month.'">Przejdź do Ewidencji</a>';
            $result[1] = $tabela;
            return $result;
        }else{
            return $check;
        }
    }
    
    function check_folder($year, $month){
        if(!file_exists('ewidencja/'.$year."/".$month)){
            if(!file_exists('ewidencja/'.$year)){
                mkdir('ewidencja/'.$year, 0777);
                mkdir('ewidencja/'.$year."/".$month, 0777);
            }else{
                mkdir('ewidencja/'.$year."/".$month, 0777);
            }
        }
    }

    function generate_PDF($odpad_kod, $year, $month, $tabela){
        $odpad_kod_plik = preg_replace("[ ]", "_", $odpad_kod);
        $plik = 'ewidencja/'.$year."/".$month."/".$odpad_kod_plik.'.pdf';
        //tworzenie pdf przy uzyciu biblioteki mpdf
        $mpdf = new mPDF('utf-8',    // mode - default ''
            'A4-L',    // format - A4, for example, default ''
            0,     // font size - default 0
            '',    // default font family
            15,    // margin_left
            15,    // margin right
            16,     // margin top
            16,    // margin bottom
            9,     // margin header
            9     // margin footer 
        );  // L - landscape, P - portrait;
        $stylesheet = file_get_contents('style/styles.css');// pobranie zawartosci styles.css
        $mpdf -> WriteHtml($stylesheet,1);//wrzucenie css-a do mpdf
        $mpdf -> WriteHtml($tabela,2);//wrzucenie tabeli do mpdf
        $mpdf->Output($plik);// zapisanie utworzonego pdf-a do pliku
    }
    
    function TablePart1($year, $month){// tworzenie górnej częsci tabeli zawierającej kod odpadu który się zmienia
        $data_sql = $year."-".$month;
        $data_nr = $month."/".$year;
        $id_odpad_select = "SELECT DISTINCT karta.id_odpad, odpad.kod, odpad.rodzaj FROM karta JOIN odpad ON karta.id_odpad = odpad.id_odpad where data LIKE CONCAT ('%$data_sql%')";
        $id_odpad = $this->db->query($id_odpad_select);
        $download = ""; 
        while ($row = mysql_fetch_object($id_odpad)) {// petla ktora leci po kodach odpadu z danego miesiaca
            $odpad_id = $row->id_odpad;
            $odpad_kod = $row->kod;
            $odpad_rodzaj = $row->rodzaj;
            $tabela = '<table id="ewid_table_ewidencja">
    <tr>
        <td colspan="5" id="ewid_table_title">KARTA EWIDENCJI ODPADU</td><td colspan="3">Nr karty: '. $data_nr .'</td><td colspan="3">Rok Kalendarzowy: '.$year.'</td>
    </tr>
    <tr>
        <td colspan="11">Kod odpadu: '. $odpad_kod.'</td>
    </tr>
    <tr>
        <td colspan="11">Rodzaj odpadu:  '. $odpad_rodzaj .'</td> </tr>';
        $tabela .= $this->TablePart2();
        $tabela .= $this->TablePart3($data_sql, $odpad_id, $month);
        
        $this->generate_PDF($odpad_kod, $year, $month, $tabela);
        $odpad_kod_plik = preg_replace("[ ]", "_", $odpad_kod);
        $plik = 'ewidencja/'.$year."/".$month."/".$odpad_kod_plik.'.pdf';
        $download .= '<a href="'.$plik.'" target="_blank">Ściagnij Ewidencję odpadu '. $odpad_kod .' za '. $data_nr.'</a><br />';
        }
        return $download;
    }
    
    function TablePart2(){ // tworzenie środkowej części tabeli zawierającej dane szpitale - zmienne stałe
        $tabela = '<tr>
        <td colspan="11">Procentowa zawartość PCB w odpadzie: -</td>
    </tr>
    <tr>
        <td colspan="11">Posiadacz odpadów: Szpital Wojewódzki w Koszalinie</td>
    </tr>
    <tr>
        <td colspan="11" class="ewid_table_td_title">Adres posiadacza odpadu</td>
    </tr>
    <tr>
        <td colspan="2" ><div class="ewid_table_td_small">Województwo</div>Zachodniopomorskie</td><td colspan="2"><div class="ewid_table_td_small">Gmina</div>Koszalin</td>
        <td colspan="2"><div class="ewid_table_td_small">Miejscowość</div>Koszalin</td><td colspan="2"><div class="ewid_table_td_small">Telefon służbowy</div>943488134</td><td colspan="3"><div class="ewid_table_td_small">Faks Służbowy</div>943488134</td>
    </tr>
    <tr>
        <td colspan="4"><div class="ewid_table_td_small">Ulica</div>Tytusa Chałubińskiego</td><td colspan="2"><div class="ewid_table_td_small">Nr domu</div>7</td><td colspan="2"><div class="ewid_table_td_small">NR lokalu</div>-</td><td colspan="3"><div class="ewid_table_td_small">Kod pocztowy</div>75-581</td>
    </tr>
    <tr>
        <td colspan="11" class="ewid_table_td_title">Miejsce prowadzenia działalności</td>
    </tr>
    <tr>
        <td colspan="2" ><div class="ewid_table_td_small">Województwo</div>Zachodniopomorskie</td><td colspan="2"><div class="ewid_table_td_small">Gmina</div>Koszalin</td>
        <td colspan="2"><div class="ewid_table_td_small">Miejscowość</div>Koszalin</td><td colspan="2"><div class="ewid_table_td_small">Telefon służbowy</div>943488134</td><td colspan="3"><div class="ewid_table_td_small">Faks Służbowy</div>943488134</td>
    </tr>
    <tr>
        <td colspan="4"><div class="ewid_table_td_small">Ulica</div>Tytusa Chałubińskiego</td><td colspan="2"><div class="ewid_table_td_small">Nr domu</div>7</td><td colspan="2"><div class="ewid_table_td_small">NR lokalu</div>-</td><td colspan="3"><div class="ewid_table_td_small">Kod pocztowy</div>75-581</td>
    </tr>
    <tr>
        <td colspan="11" class="ewid_table_td_title">Działalność w zakresie:</td>
        </tr>
    <tr>
        <td colspan="2" class="ewid_table_check"><input type="checkbox" checked="checked" >W</td><td colspan="2" class="ewid_table_check"><input type="checkbox" >Zb</td>
        <td colspan="2" class="ewid_table_check"><input type="checkbox">Od </td><td colspan="2" class="ewid_table_check"><input type="checkbox">Un</td>
        <td colspan="3" class="ewid_table_check"><input type="checkbox">Ok</td>
    </tr>
    <tr>
        <td rowspan="3" class="ewid_table_td_title">Miesiąc</td><td rowspan="3" class="ewid_table_td_title">Masa Wytworzonych odpadów [Mg]</td>
        <td rowspan="3" class="ewid_table_td_title">Masa odebranych odpadów komunalnych [Mg]</td><td rowspan="3" class="ewid_table_td_title">Masa przyjętych odpadów [Mg]</td>
        <td rowspan="3" class="ewid_table_td_title">Nr karty przekazania odpadów</td><td colspan="6" class="ewid_table_td_title">Gospodarowanie odpadami</td>
    </tr>
    <tr>
        <td colspan="3" class="ewid_table_td_title">we własnym zakresie</td><td colspan="2" class="ewid_table_td_title">odpady przekazane</td><td rowspan="2" class="ewid_table_td_title">imię i nazwisko osoby sporządzającej</td>
    </tr>
    <tr>
        <td class="ewid_table_td_title">masa [Mg]</td><td class="ewid_table_td_title">metoda odzysku</td><td class="ewid_table_td_title">Metoda unieszkoliwiania</td><td class="ewid_table_td_title">masa [Mg]</td><td class="ewid_table_td_title">nr karty przekazania odpadu</td>
    </tr>';
    return $tabela;
    }

    function TablePart3($data_sql, $odpad_id, $month){ // tworzenie dolnej częsci tabeli zawierającej wszystkie karty opdadu z danego kodu odpadu i danego miesiaca
        $query = "SELECT karta.numer_karty, karta.masa, user.name, user.surname FROM karta ";
        $query .= "JOIN user on karta.id_user  = user.id_user where id_odpad = ".$odpad_id." and data LIKE CONCAT ('%".$data_sql."%')";
        $cards = $this->db->query($query);
        $masa_suma = 0;
        while ($dane = mysql_fetch_object($cards)){ // petla ktora leci po wszystkich kartach odpadu z danego odpadu i danego miesiaca
            $tabela .= '<tr>';
            $tabela .= '<td class="ewid_table_check">'.$month.'</td>';
            $tabela .= '<td class="ewid_table_check">'.$dane->masa.'</td>';
            $tabela .= '<td></td><td></td>';
            $tabela .= '<td class="ewid_table_check">'.$dane->numer_karty.'</td>';
            $tabela .= '<td></td><td></td><td></td>';
            $tabela .= '<td class="ewid_table_check">'.$dane->masa.'</td>';
            $tabela .= '<td class="ewid_table_check">'.$dane->numer_karty.'</td>';
            $tabela .= '<td class="ewid_table_check">'.$dane->name.' '.$dane->surname.'</td>';
            $tabela .= '</tr>';
            //$masa = str_replace(",",".",$dane->masa);
            $masa_suma = $masa_suma + $dane->masa;
        }
        $tabela .='<tr><td class="ewid_table_check"><b>Suma</b></td><td class="ewid_table_check"><b>'.$masa_suma.'</b></td><td></td><td></td><td></td><td></td><td></td><td></td><td class="ewid_table_check"><b>'.$masa_suma.'</b></td><td></td><td></td></tr>';
        $tabela .= '</table>';
        return $tabela;
        
    }

}


?>
